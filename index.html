<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style type="text/css">
            html, body {
                padding: 0;
                margin: 0;
                width:100%;
                height:100vh;
                overflow: hidden;
                min-width: 960px;
            }

            p{
                padding: 0;
                margin: 0;
            }

            header{
                padding: 0;
                margin: 0;
                height: 10vh;
                width: 100%;
                background-color: black;
                color:white;
            }
            footer{
                padding: 0;
                margin: 0;
                height: 10vh;
                width: 100%;
                background-color: black;
                color:rgb(231, 231, 231);
                font-size: 12px;
            }
            #main{
                padding: 0;
                margin: 0;
                height: 80vh;
                width: 100%;
                display: flex;

            }
            #preview{
                background: black;
                width: 50%;
                min-width: 480px;
                display: flex;
                justify-content: center;
                align-items: center;
            }

            #edit{
                background:black;
                width: 50%;
                min-width: 480px;
                display: flex;
                justify-content: center;
                align-items: center;
                flex-direction: column
            }

            #edit label{
                color: white;
                font-size: 12px;
                font-family: "zcool-gdh";
                display: block;
            }

            #preview canvas,img{
                width: 100%;
            }


            input[type="text"]{
                height: 32px;
                width: 198px;
                border-radius: 4px;
                font-size: 18px;
                font-family: "zcool-gdh";
                padding: 8px;
                border: none;
            }

            input[type="range"]{
                height: 32px;
                width: 198px;
                border-radius: 4px;
                font-size: 18px;
                font-family: "zcool-gdh";
                padding: 8px;
                border: none;
            }

            .radioGroup{
                width: 198px;
                display: flex;
                justify-content: space-around;
            }

            .shadow{
                
                box-shadow:1px 10px 16px 2px rgba(0,0,0,0.4);
            }

            .title{
                color: white;
                font-size: 18px;
                font-family: "zcool-gdh";
                margin-bottom: 14px;
                margin-top: 32px;
                border-left: 8px solid rgb(112, 35, 255);
                padding-left: 18px;
            }

            .option{
                width: 210px;
            }

            .rowDisplay{
                display: flex;
                flex-direction: row;
                justify-content: center;
                align-items: center;
            }
          
            
    </style>
    <script src="../js/canvas2svg.js"></script>
    <!--<script src="https://cdn.bootcss.com/sketch.js/1.1/sketch.min.js"></script>
    <script src="https://cdn.bootcss.com/opentype.js/0.8.0/opentype.min.js"></script>-->
    
    <script src="https://cdn.bootcss.com/gif.js/0.2.0/gif.js"></script>
   
</head>
<body>
    <header>
        <nav>xxx</nav>

    </header>
    <div id="main">
        <div id="preview"></div>
        <div id="edit">

            <div class="option">
                <div class="title">输入内容</div>
                <input type="text" maxlength="24" class="shadow" value="HELLO WORLD" id="word">
            </div>

            
            <div class="option">
                    <div class="title">字体大小</div>
                    <input type="range" step="1" min="10" onchange="changeFontSize()" id="fontSize">
            </div>

            <div class="option">
                    <div class="title">抖动幅度</div>
                    <input type="range" step="2" min="1" onchange="changeSeed()" id="seed">
            </div>

            <div class="option">
                    <div class="title">切割线</div>

                    <div class="rowDisplay">

                            <input id="isdev" type="checkbox"  onchange="changeDev()" ><label for="isdev" id="isdev_label">显示</lable> 
                    
                    </div>
                            
                     

                    
                      
            </div>


            <div class="option">
                    <div class="title">图片格式</div>

                    <div class="radioGroup">
                            <div class="rowDisplay">
                                    <input id="type_png" type="radio" name="type" onchange="changeType()" checked><label for="type_png">PNG</lable> 
                            </div>
        
                            <div class="rowDisplay">
                                    <input id="type_gif" type="radio" name="type" onchange="changeType()"><label for="type_gif">GIF</lable> 
        
                            </div>

                    </div>

                    
                      
            </div>
            
            
        </div>
    </div>
    <footer>

        <p>MIT License</p>
        <p>by shadow</p>

    </footer>
    <script>
        //https://github.com/jnordberg/gif.js

    
    Array.prototype.sum = function (){
        return this.reduce(function (partial, value){
        return partial + value;
        })
    };


    function DYText(opts){

        var _opts=opts||{};

        this.word=_opts.word||"Hello World";
        
 
        this.fontSize=_opts.fontSize+'px' || '120px';
        this.height=_opts.fontSize||120;
        this.fontFamily=_opts.fontFamily||'zcool-gdh';
        this.font="italic small-caps 900 "+this.fontSize+" "+this.fontFamily;
        this.offset=(this.height*_opts.offset)||this.height*0.015;
        
        this.x=_opts.x||0;
        this.y=_opts.y||0;

        this.divideNum=_opts.divideNum||6;
        this.seed=_opts.seed||0.51;

        this.offsetLeft=true;


        this.colorLeft=_opts.colorLeft||"yellow";
        this.colorRight=_opts.colorRight||"red";
        this.color=_opts.color||"black";
        this.colorBg=_opts.colorBg||'black';

        this.fullscreen=true;

        this.dev=!!_opts.dev;

        this.gifLength=_opts.gifLength||10;


        var canvas=document.createElement('canvas');
        var ctx=canvas.getContext('2d');
        this.ctx=ctx;

    };

    DYText.prototype.setFontSize=function(_num){
        this.fontSize=_num+'px' || '120px';
        this.height=_num ||120;
        this.font="italic small-caps 900 "+this.fontSize+" "+this.fontFamily;
        this.offset=this.height*0.015;
    };




    DYText.prototype.random=function(min,max){
        var num=Math.random()*(max-min)+min;
        return num
    };

    DYText.prototype.sin=function(len){
        console.log(len);
        var res=[];
        for(var i=0;i<len;i++){
            var num=parseFloat(Math.abs(Math.sin(this.random(0,6))).toString().slice(0,4))*100;
            res.push(num);
        };
        
        var sum=res.sum();

        for(var i=0;i<res.length;i++){
            res[i]=res[i]/sum;
           // console.log(res[i],"ijujujuj")
        };

     
        return res;
    };


    DYText.prototype.generate=function(){

        var res=[];

        var x=this.x,
            y=this.y,
            width=this.width,
            height=this.height,
            seed=this.seed;
            
            //console.log(height,'!!')
        



        var i=this.divideNum;

        var height_seeds=this.sin(i);

       // console.log(x,y,width,height,height_seeds)

        for (let index = 0; index < i; index++) {

            this.offsetLeft=!this.offsetLeft;

           // console.log(height*height_seeds[index],'!!!')
            
            var _yn=(index==0?0:(res[index-1].get.height+res[index-1].get.y)),
                _h=height*height_seeds[index];

            if (_h<=2) {
                _h=2;
            };

            var get={
                x:x,
                y:_yn,
                width:width,
                height:_h
            },
            put={
                x:x+index*(this.offsetLeft?-1:1)*seed,
                y:_yn
            },
            obj={
                get:get,
                put:put
            };

            res.push(obj);
            
        
        };

        this.divides=res;
    };

    DYText.prototype.start=function(){
        
        if (this._status='READY') {
            this.update();
        }else{
            this.init();
            this.draw();
            this.drawBg();
            this.generate();
            this.copy();
            this._status='READY';
        };

    };


    DYText.prototype.update=function(seed){

        this.seed=seed||this.seed;

        if (this._status='READY') {
            this.ctx.clearRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);  
            this.init();
            this.draw();
            this.drawBg();
            this.generate();
            this.copy();
        }else{
            this.start();
        };
           

    };

    DYText.prototype.init=function(){
        var canvas=this.ctx.canvas,
            ctx=this.ctx;

        ctx.textBaseline="top";
        ctx.font=this.font;

        var word=this.word,
            offset=this.offset;    

        this.width=ctx.measureText(word).width+this.offset*2;
        
        canvas.width=this.width+100;
        this.x=50;
        canvas.height =this.height;

      //  this.ctx.fillStyle=this.colorBg;
       // this.ctx.fillRect(0,0,canvas.width,canvas.height);
    };

    DYText.prototype.drawBg=function(){
        var canvasBg=document.createElement('canvas'),
            ctxBg=canvasBg.getContext('2d');
        
        canvasBg.width=this.ctx.canvas.width;
        canvasBg.height=this.ctx.canvas.height;


        ctxBg.fillStyle=this.colorBg;
        ctxBg.fillRect(0,0,this.ctx.canvas.width,this.ctx.canvas.height);

        var word=this.word,
            offset=this.offset,
            x=this.x,
            y=this.y;

        var ctx=this.ctx;

        ctxBg.textBaseline="top";
        ctxBg.font=this.font;
        
        ctxBg.fillStyle=this.color;
        ctxBg.fillText(word,x+offset,y+offset);
       
        ctxBg.drawImage(ctx.canvas,0,0);

        ctx.drawImage(canvasBg,0,0);
    };

    DYText.prototype.draw=function(){
        var word=this.word,
            offset=this.offset,
            x=this.x,
            y=this.y;

        var ctx=this.ctx;

        ctx.textBaseline="top";
        ctx.font=this.font;

        ctx.fillStyle=this.colorLeft;
        ctx.fillText(word,x-offset,y-offset);
        
       // ctx.fillStyle=this.color;
        //ctx.fillText(word,x,y);
        
        ctx.globalCompositeOperation="xor";
        ctx.fillStyle=this.colorRight;
        ctx.fillText(word,x+offset,y+offset);
        
       /* ctx.globalCompositeOperation="xor";
        ctx.fillStyle=this.color;
        ctx.fillText(word,x,y);
        */
        ctx.globalCompositeOperation="source-over";

    };

    DYText.prototype.copy=function(){

        var divides=this.divides;
        var ctx=this.ctx;   
        
       // console.log(divides)

        ctx.globalCompositeOperation="source-over";
        
        for (let index = 0; index < divides.length; index++) {
            var d=divides[index];
         
            var imgData=ctx.getImageData(d.get.x,d.get.y,d.get.width,d.get.height);

            ctx.putImageData(imgData,d.put.x,d.put.y);
            
            if (this.dev) {
                
                ctx.strokeStyle="red";
                ctx.strokeRect(d.get.x,d.get.y,d.get.width,d.get.height);
            }
        };


      

    };


    DYText.prototype.toCanvas=function(targetCtx){
       
        var ctx=this.ctx;
        targetCtx.canvas.width=ctx.canvas.width;
        targetCtx.canvas.height=ctx.canvas.height;

        targetCtx.drawImage(ctx.canvas,0,0);
    };

  

    DYText.prototype.createFrames=function(num){
        var frames=[],num=num||this.gifLength;

        for (let index = 0; index < num; index++) {
            this.update();

            var canvas1=document.createElement('canvas'),
                ctx1=canvas1.getContext('2d');
            
                canvas1.width=window.innerWidth;
                canvas1.height=window.innerHeight;
                
            this.toCanvas(ctx1);

            frames.push(canvas1);
            
        };

        this.frames=frames;

        return frames;
    };

    DYText.prototype.createGif=function(cb){
        
        var gif = new GIF({
                workers: 8,
                quality: 10,
                workerScript:'./gif.worker.js'
            });
            
            
            var frames=this.createFrames();

            for (let index = 0; index < frames.length; index++) {
                        
                    gif.addFrame(frames[index], {delay:200})
                    
            };


            gif.on('finished', function(blob) {
               
                cb(URL.createObjectURL(blob));
                
            });

            gif.render();
    };



    var dytext;
    var type_png=true;
    var previewElement=document.querySelector('#preview');
    var wordElement=document.querySelector('#word');
    var fontSizeElement=document.querySelector('#fontSize');
    var seedElement=document.querySelector('#seed');
    var typeGifElement=document.querySelector('#type_gif');
    var typePngElement=document.querySelector('#type_png');
    var idDevElement=document.querySelector('#isdev');


    init();



    wordElement.addEventListener('change',function(e){
        var _w=this.value;
        dytext.word=_w;
        updatePreview();

    });


    function init(){
        var _w=wordElement.value,
            _fs=fontSizeElement.value,
            _s=seedElement.value*0.03,
            _dev=idDevElement.checked;
        
  


        dytext=new DYText({
            word:_w,
            color:'white',
            colorBg:'#1F0D1C',
            colorLeft:'#00F5EB',
            colorRight:'#FF0050',
            dev:_dev,
            seed:_s,
            fontSize:_fs
        });
        
        updatePreview();
    };



    function createImg(){
        var canvasTarget=document.createElement('canvas'),
        ctxTarget=canvasTarget.getContext('2d');
        canvasTarget.width=window.innerWidth;
        dytext.start();
        dytext.toCanvas(ctxTarget);
        previewElement.innerHTML='';
        previewElement.appendChild(canvasTarget);
    };

    function createGif(){
        dytext.createGif(function(gif){

        var img=document.createElement('img');
            img.src=gif;
            previewElement.innerHTML='';
            previewElement.appendChild(img);
        })
    };

 
    function changeSeed(){
        var _s=seedElement.value;
        var _seed=0.03*_s;
        console.log(_seed);
        dytext.seed=_seed;
        updatePreview();
    };

    function changeFontSize(){
        var _fs=fontSizeElement.value;
        var _fontSize=Math.round(0.01*_fs*200);
        dytext.setFontSize(_fontSize);
        updatePreview();
        console.log(_fontSize);

    };

    function changeType(){
        var png=typePngElement.checked;
      
            type_png=png;

            updatePreview();
       // console.log(png)
    };

    function changeDev(){
        var _d=idDevElement.checked;
        console.log(_d)
        dytext.dev=_d;
         
        updatePreview();
    };

    function updatePreview(){
        if (type_png) {
            createImg();
        }else{
            createGif();
        };
    };

        
    </script>
</body>
</html>
